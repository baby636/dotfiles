#!/bin/bash -e
proto_user="$1"
username="${proto_user:3}"

[ -z "${proto_user}" ] && \
    echo "Please provide gh:<username> (for GitHub) or lp:<username> (for Launchpad)" && \
    exit 1

set -x

sudo ssh-import-id "${proto_user}" -o - &>/dev/null

if ! sudo grep -q "coworkers" /etc/group; then
    sudo groupadd coworkers
fi

tmux_socket=/tmp/tmux-shared-socket
tmux_cmd="tmux -S $tmux_socket new-session -s shared"

if ! id -u "$username" &>/dev/null ; then
    sudo adduser --disabled-password --shell /bin/bash --gecos "" "$username"
    sudo adduser "$username" coworkers
    sudo su "$username" -c "ssh-import-id $proto_user"
    sudo -- sh -c "echo && echo 'exec $tmux_cmd -A' >> /home/$username/.bashrc"
fi

if ! tmux -S $tmux_socket ls &>/dev/null; then
    eval "$tmux_cmd -d" && sudo chgrp coworkers $tmux_socket
fi

[ "$tmux_socket" == $(echo $TMUX | cut -f1 -d',') ] && exit 0

if [[ ! $TERM =~ screen ]]; then
    eval "$tmux_cmd -A"
else
    { set +x; } >/dev/null
    echo
    echo "Run outside of tmux:"
    echo
    echo "  $tmux_cmd -A"
    echo
fi
