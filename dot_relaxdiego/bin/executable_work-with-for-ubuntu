#!/bin/bash -e
proto_user="$1"
username="${proto_user:3}"

[ -z "${proto_user}" ] && \
    echo "Please provide gh:<username> (for GitHub) or lp:<username> (for Launchpad)" && \
    exit 1

set -x

sudo ssh-import-id "${proto_user}" -o - &>/dev/null

if ! sudo grep -q "coworkers" /etc/group; then
    sudo groupadd coworkers
fi

if ! id -u "$username" &>/dev/null ; then
    sudo adduser --disabled-password --shell /bin/bash --gecos "" "$username"
    sudo adduser "$username" coworkers
fi

sudo su "$username" -c "ssh-import-id $proto_user"

if ! tmux -S /tmp/shared-tmux-socket ls; then
    tmux -S /tmp/shared-tmux-socket new-session -d && sudo chgrp coworkers /tmp/shared-tmux-socket
fi
